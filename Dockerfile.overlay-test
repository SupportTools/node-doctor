# Dockerfile for overlay-test-server - minimal HTTP health endpoint for CNI probing
# Multi-stage build targeting scratch for ~6-8MB final image

FROM golang:1.25-alpine AS builder

WORKDIR /build

# Copy go mod files first for layer caching
COPY go.mod go.sum ./
RUN go mod download

# Copy source
COPY . .

# Build static binary
ARG TARGETARCH
RUN CGO_ENABLED=0 GOOS=linux GOARCH=${TARGETARCH} go build \
    -ldflags="-w -s" \
    -trimpath \
    -o overlay-test-server \
    ./cmd/overlay-test-server

# Runtime stage - scratch for minimal image
FROM scratch

COPY --from=builder /build/overlay-test-server /overlay-test-server

# Run as nobody (65534)
USER 65534:65534

EXPOSE 8023

ENTRYPOINT ["/overlay-test-server"]

LABEL org.opencontainers.image.title="Node Doctor Overlay Test Server" \
      org.opencontainers.image.description="Minimal HTTP health server for CNI overlay network connectivity testing" \
      org.opencontainers.image.vendor="SupportTools" \
      org.opencontainers.image.source="https://github.com/supporttools/node-doctor"
