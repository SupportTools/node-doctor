apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ include "node-doctor.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "node-doctor.labels" . | nindent 4 }}
    version: {{ .Chart.AppVersion | quote }}
    k8s-app: {{ include "node-doctor.name" . }}
  annotations:
    description: "Node Doctor - Kubernetes node monitoring and auto-remediation DaemonSet"
    docs: "https://github.com/supporttools/node-doctor"
spec:
  updateStrategy:
    type: {{ .Values.updateStrategy.type }}
    {{- if eq .Values.updateStrategy.type "RollingUpdate" }}
    rollingUpdate:
      maxUnavailable: {{ .Values.updateStrategy.rollingUpdate.maxUnavailable }}
    {{- end }}

  selector:
    matchLabels:
      {{- include "node-doctor.selectorLabels" . | nindent 6 }}

  template:
    metadata:
      labels:
        {{- include "node-doctor.selectorLabels" . | nindent 8 }}
        version: {{ .Chart.AppVersion | quote }}
        k8s-app: {{ include "node-doctor.name" . }}
        {{- with .Values.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      annotations:
        {{- with .Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        # Security annotations
        container.apparmor.security.beta.kubernetes.io/node-doctor: "unconfined"
        scheduler.alpha.kubernetes.io/critical-pod: ""
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      priorityClassName: {{ .Values.priorityClassName }}

      hostNetwork: {{ .Values.hostNetwork }}
      hostPID: {{ .Values.hostPID }}
      dnsPolicy: {{ .Values.dnsPolicy }}

      serviceAccountName: {{ include "node-doctor.serviceAccountName" . }}

      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}

      tolerations:
        {{- toYaml .Values.tolerations | nindent 8 }}

      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      containers:
      - name: node-doctor
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}

        command: ["/usr/local/bin/node-doctor"]
        args:
          - "--config=/etc/node-doctor/config.yaml"
          - "--log-level={{ .Values.settings.logLevel }}"
          - "--log-format={{ .Values.settings.logFormat }}"

        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: VERSION
          value: {{ .Chart.AppVersion | quote }}
        - name: GOMAXPROCS
          value: "2"

        securityContext:
          {{- toYaml .Values.securityContext | nindent 10 }}

        resources:
          {{- toYaml .Values.resources | nindent 10 }}

        ports:
        - name: http
          containerPort: {{ .Values.service.httpPort }}
          protocol: TCP
        - name: metrics
          containerPort: {{ .Values.service.metricsPort }}
          protocol: TCP

        {{- if .Values.probes.liveness.enabled }}
        livenessProbe:
          httpGet:
            path: {{ .Values.probes.liveness.httpGet.path }}
            port: {{ .Values.probes.liveness.httpGet.port }}
            scheme: HTTP
          initialDelaySeconds: {{ .Values.probes.liveness.initialDelaySeconds }}
          periodSeconds: {{ .Values.probes.liveness.periodSeconds }}
          timeoutSeconds: {{ .Values.probes.liveness.timeoutSeconds }}
          failureThreshold: {{ .Values.probes.liveness.failureThreshold }}
          successThreshold: {{ .Values.probes.liveness.successThreshold }}
        {{- end }}

        {{- if .Values.probes.readiness.enabled }}
        readinessProbe:
          httpGet:
            path: {{ .Values.probes.readiness.httpGet.path }}
            port: {{ .Values.probes.readiness.httpGet.port }}
            scheme: HTTP
          initialDelaySeconds: {{ .Values.probes.readiness.initialDelaySeconds }}
          periodSeconds: {{ .Values.probes.readiness.periodSeconds }}
          timeoutSeconds: {{ .Values.probes.readiness.timeoutSeconds }}
          failureThreshold: {{ .Values.probes.readiness.failureThreshold }}
          successThreshold: {{ .Values.probes.readiness.successThreshold }}
        {{- end }}

        {{- if .Values.probes.startup.enabled }}
        startupProbe:
          httpGet:
            path: {{ .Values.probes.startup.httpGet.path }}
            port: {{ .Values.probes.startup.httpGet.port }}
            scheme: HTTP
          initialDelaySeconds: {{ .Values.probes.startup.initialDelaySeconds }}
          periodSeconds: {{ .Values.probes.startup.periodSeconds }}
          timeoutSeconds: {{ .Values.probes.startup.timeoutSeconds }}
          failureThreshold: {{ .Values.probes.startup.failureThreshold }}
          successThreshold: {{ .Values.probes.startup.successThreshold }}
        {{- end }}

        volumeMounts:
        # Configuration mount
        - name: config
          mountPath: /etc/node-doctor
          readOnly: true

        # Host filesystem mounts
        - name: host-root
          mountPath: /host
          readOnly: true
          mountPropagation: HostToContainer

        - name: host-var-log
          mountPath: /var/log
          readOnly: true

        - name: host-kmsg
          mountPath: /dev/kmsg
          readOnly: true

        - name: host-proc
          mountPath: /host/proc
          readOnly: true

        - name: host-sys
          mountPath: /host/sys
          readOnly: true

        - name: host-etc-kubernetes
          mountPath: /etc/kubernetes
          readOnly: true

        # Container runtime sockets
        - name: docker-sock
          mountPath: /var/run/docker.sock
          readOnly: true

        - name: containerd-sock
          mountPath: /run/containerd/containerd.sock
          readOnly: true

        - name: crio-sock
          mountPath: /var/run/crio/crio.sock
          readOnly: true

        # Additional mounts
        - name: host-journal
          mountPath: /var/log/journal
          readOnly: true

        - name: host-machine-id
          mountPath: /etc/machine-id
          readOnly: true

        - name: host-os-release
          mountPath: /host/etc/os-release
          readOnly: true

      volumes:
      # Configuration volume from ConfigMap
      - name: config
        configMap:
          name: {{ include "node-doctor.configMapName" . }}
          defaultMode: 0644
          items:
          - key: config.yaml
            path: config.yaml

      # Host path volumes
      - name: host-root
        hostPath:
          path: /
          type: Directory

      - name: host-var-log
        hostPath:
          path: /var/log
          type: Directory

      - name: host-kmsg
        hostPath:
          path: /dev/kmsg
          type: CharDevice

      - name: host-proc
        hostPath:
          path: /proc
          type: Directory

      - name: host-sys
        hostPath:
          path: /sys
          type: Directory

      - name: host-etc-kubernetes
        hostPath:
          path: /etc/kubernetes
          type: DirectoryOrCreate

      # Container runtime sockets
      - name: docker-sock
        hostPath:
          path: /var/run/docker.sock

      - name: containerd-sock
        hostPath:
          path: /run/containerd/containerd.sock

      - name: crio-sock
        hostPath:
          path: /var/run/crio/crio.sock

      - name: host-journal
        hostPath:
          path: /var/log/journal
          type: DirectoryOrCreate

      - name: host-machine-id
        hostPath:
          path: /etc/machine-id
          type: File

      - name: host-os-release
        hostPath:
          path: /etc/os-release
          type: File

      restartPolicy: Always
      terminationGracePeriodSeconds: {{ .Values.terminationGracePeriodSeconds }}
