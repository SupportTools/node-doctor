{{- if .Values.overlayTest.enabled }}
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: {{ include "node-doctor.fullname" . }}-overlay-test
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "node-doctor.labels" . | nindent 4 }}
    app.kubernetes.io/component: overlay-test
spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: {{ .Values.overlayTest.updateStrategy.maxUnavailable | default "25%" }}

  selector:
    matchLabels:
      app: {{ include "node-doctor.name" . }}-overlay-test
      app.kubernetes.io/name: {{ include "node-doctor.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}

  template:
    metadata:
      labels:
        app: {{ include "node-doctor.name" . }}-overlay-test
        app.kubernetes.io/name: {{ include "node-doctor.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/component: overlay-test
      annotations:
        description: "Node Doctor overlay network test pod - HTTP health server for CNI connectivity testing"
    spec:
      # NO hostNetwork - this pod uses the overlay network
      hostNetwork: false

      # Use cluster DNS (default)
      dnsPolicy: ClusterFirst

      # Low priority - these are test pods
      priorityClassName: {{ .Values.overlayTest.priorityClassName | default "" | quote }}

      serviceAccountName: {{ include "node-doctor.serviceAccountName" . }}

      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      # Tolerate all taints to run on every node
      tolerations:
        - operator: Exists

      nodeSelector:
        kubernetes.io/os: linux

      terminationGracePeriodSeconds: 5

      containers:
      - name: overlay-test
        image: "{{ .Values.overlayTest.image.repository }}:{{ .Values.overlayTest.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.overlayTest.image.pullPolicy }}

        command: ["/overlay-test-server"]
        args: ["--port={{ .Values.overlayTest.port | default 8023 }}"]

        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP

        ports:
        - name: health
          containerPort: {{ .Values.overlayTest.port | default 8023 }}
          protocol: TCP

        # Minimal security context
        securityContext:
          runAsNonRoot: true
          runAsUser: 65534
          runAsGroup: 65534
          readOnlyRootFilesystem: true
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL

        # Minimal resources
        resources:
          requests:
            cpu: {{ .Values.overlayTest.resources.requests.cpu | default "1m" }}
            memory: {{ .Values.overlayTest.resources.requests.memory | default "8Mi" }}
          limits:
            cpu: {{ .Values.overlayTest.resources.limits.cpu | default "10m" }}
            memory: {{ .Values.overlayTest.resources.limits.memory | default "16Mi" }}

        # HTTP liveness probe on /healthz
        livenessProbe:
          httpGet:
            path: /healthz
            port: health
          initialDelaySeconds: 5
          periodSeconds: 30
          timeoutSeconds: 3
          failureThreshold: 3

        # HTTP readiness probe on /healthz
        readinessProbe:
          httpGet:
            path: /healthz
            port: health
          initialDelaySeconds: 2
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 1
{{- end }}
