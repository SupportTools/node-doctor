# RBAC configuration for Node Doctor Kubernetes Exporter
# This file defines the necessary permissions for Node Doctor to interact with the Kubernetes API
# to create events, update node conditions, and manage node annotations.

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: node-doctor
  namespace: kube-system
  labels:
    app.kubernetes.io/name: node-doctor
    app.kubernetes.io/component: node-monitor
    app.kubernetes.io/part-of: node-doctor
automountServiceAccountToken: true

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: node-doctor
  labels:
    app.kubernetes.io/name: node-doctor
    app.kubernetes.io/component: node-monitor
    app.kubernetes.io/part-of: node-doctor
rules:
# Node permissions - required for updating node conditions and annotations
- apiGroups: [""]
  resources: ["nodes"]
  verbs: ["get", "list", "watch", "patch", "update"]

# Node status permissions - required for updating node status (conditions)
- apiGroups: [""]
  resources: ["nodes/status"]
  verbs: ["patch", "update"]

# Event permissions - required for creating and listing events
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "list", "patch", "update"]

# Pod permissions - optional, for future pod-related monitoring
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]

# Lease permissions - for leader election (if implemented in the future)
- apiGroups: ["coordination.k8s.io"]
  resources: ["leases"]
  verbs: ["create", "get", "list", "update", "patch", "watch", "delete"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: node-doctor
  labels:
    app.kubernetes.io/name: node-doctor
    app.kubernetes.io/component: node-monitor
    app.kubernetes.io/part-of: node-doctor
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: node-doctor
subjects:
- kind: ServiceAccount
  name: node-doctor
  namespace: kube-system

---
# Optional: Role for namespace-specific operations
# This is useful if you want to restrict Node Doctor to specific namespaces for events
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: node-doctor-events
  namespace: default
  labels:
    app.kubernetes.io/name: node-doctor
    app.kubernetes.io/component: node-monitor
    app.kubernetes.io/part-of: node-doctor
rules:
# Event permissions in specific namespace
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "list", "patch", "update"]

---
# Optional: RoleBinding for namespace-specific operations
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: node-doctor-events
  namespace: default
  labels:
    app.kubernetes.io/name: node-doctor
    app.kubernetes.io/component: node-monitor
    app.kubernetes.io/part-of: node-doctor
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: node-doctor-events
subjects:
- kind: ServiceAccount
  name: node-doctor
  namespace: kube-system

---
# Security Policy (if using Pod Security Standards)
apiVersion: v1
kind: ConfigMap
metadata:
  name: node-doctor-security-policy
  namespace: kube-system
  labels:
    app.kubernetes.io/name: node-doctor
    app.kubernetes.io/component: node-monitor
    app.kubernetes.io/part-of: node-doctor
data:
  security-policy.yaml: |
    # Pod Security Standards configuration for Node Doctor
    # This ensures Node Doctor pods run with minimal privileges

    securityContext:
      runAsNonRoot: true
      runAsUser: 65534  # nobody user
      runAsGroup: 65534 # nobody group
      fsGroup: 65534
      seccompProfile:
        type: RuntimeDefault

    containers:
    - name: node-doctor
      securityContext:
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        runAsNonRoot: true
        runAsUser: 65534
        runAsGroup: 65534
        capabilities:
          drop:
          - ALL
        seccompProfile:
          type: RuntimeDefault

      # Resource limits
      resources:
        requests:
          memory: "64Mi"
          cpu: "100m"
        limits:
          memory: "256Mi"
          cpu: "500m"

      # Volume mounts (read-only where possible)
      volumeMounts:
      - name: config
        mountPath: /etc/node-doctor
        readOnly: true
      - name: kubeconfig
        mountPath: /etc/kubernetes
        readOnly: true
      - name: tmp
        mountPath: /tmp

---
# NetworkPolicy (optional) - restricts network access for Node Doctor pods
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: node-doctor-network-policy
  namespace: kube-system
  labels:
    app.kubernetes.io/name: node-doctor
    app.kubernetes.io/component: node-monitor
    app.kubernetes.io/part-of: node-doctor
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: node-doctor
  policyTypes:
  - Ingress
  - Egress

  # Ingress rules (what can connect to Node Doctor)
  ingress:
  # Allow health check and metrics endpoints
  - from: []
    ports:
    - protocol: TCP
      port: 8080  # Health/status endpoint
    - protocol: TCP
      port: 9100  # Metrics endpoint

  # Egress rules (what Node Doctor can connect to)
  egress:
  # Allow connection to Kubernetes API server
  - to: []
    ports:
    - protocol: TCP
      port: 443   # HTTPS to API server
    - protocol: TCP
      port: 6443  # Alternative API server port

  # Allow DNS resolution
  - to: []
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

  # Allow kubelet health checks (if needed)
  - to: []
    ports:
    - protocol: TCP
      port: 10248 # Kubelet health port
    - protocol: TCP
      port: 10250 # Kubelet API port (if needed)

---
# Sample DaemonSet configuration showing how to use the RBAC
# This is for reference and would typically be in a separate deployment file
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: node-doctor
  namespace: kube-system
  labels:
    app.kubernetes.io/name: node-doctor
    app.kubernetes.io/component: node-monitor
    app.kubernetes.io/part-of: node-doctor
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: node-doctor
  template:
    metadata:
      labels:
        app.kubernetes.io/name: node-doctor
        app.kubernetes.io/component: node-monitor
    spec:
      serviceAccountName: node-doctor  # Use the service account defined above
      hostNetwork: false               # Use pod network for better security
      hostPID: false                   # Don't access host PID namespace
      hostIPC: false                   # Don't access host IPC namespace

      # Node selection - run on all nodes by default
      tolerations:
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule

      containers:
      - name: node-doctor
        image: node-doctor:latest

        # Use the security context from the ConfigMap above
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 65534
          runAsGroup: 65534
          capabilities:
            drop:
            - ALL

        # Environment variables
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace

        # Resource constraints
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "500m"

        # Health checks
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3

        readinessProbe:
          httpGet:
            path: /ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3

        # Volume mounts
        volumeMounts:
        - name: config
          mountPath: /etc/node-doctor
          readOnly: true
        - name: tmp
          mountPath: /tmp

        # Ports
        ports:
        - name: http-health
          containerPort: 8080
          protocol: TCP
        - name: http-metrics
          containerPort: 9100
          protocol: TCP

      # Volumes
      volumes:
      - name: config
        configMap:
          name: node-doctor-config
      - name: tmp
        emptyDir: {}

      # Priority and scheduling
      priorityClassName: system-node-critical

      # Restart policy
      restartPolicy: Always

      # Termination grace period
      terminationGracePeriodSeconds: 30